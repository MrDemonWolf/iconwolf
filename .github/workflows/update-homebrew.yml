name: Update Homebrew Tap

on:
  workflow_run:
    workflows: ["Build Binary"]
    types: [completed]

jobs:
  update-tap:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get release tag
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download release assets and compute sha256
        id: hashes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}"

          curl -sL "${BASE_URL}/iconwolf-macos-arm64.tar.gz" -o arm64.tar.gz
          curl -sL "${BASE_URL}/iconwolf-macos-x64.tar.gz" -o x64.tar.gz
          curl -sL "${BASE_URL}/iconwolf-linux-x64.tar.gz" -o linux.tar.gz

          echo "sha256_arm64=$(sha256sum arm64.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "sha256_x64=$(sha256sum x64.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "sha256_linux=$(sha256sum linux.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          repository: MrDemonWolf/homebrew-den
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-den

      - name: Write updated formula
        env:
          TAG: ${{ steps.release.outputs.tag }}
          VERSION: ${{ steps.release.outputs.version }}
          SHA256_ARM64: ${{ steps.hashes.outputs.sha256_arm64 }}
          SHA256_X64: ${{ steps.hashes.outputs.sha256_x64 }}
          SHA256_LINUX: ${{ steps.hashes.outputs.sha256_linux }}
        run: |
          cat > homebrew-den/Formula/iconwolf.rb << RUBY
          class Iconwolf < Formula
            desc "Cross-platform app icon generator for Expo/React Native projects"
            homepage "https://github.com/MrDemonWolf/iconwolf"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/MrDemonWolf/iconwolf/releases/download/${TAG}/iconwolf-macos-arm64.tar.gz"
                sha256 "${SHA256_ARM64}"
              else
                url "https://github.com/MrDemonWolf/iconwolf/releases/download/${TAG}/iconwolf-macos-x64.tar.gz"
                sha256 "${SHA256_X64}"
              end
            end

            on_linux do
              url "https://github.com/MrDemonWolf/iconwolf/releases/download/${TAG}/iconwolf-linux-x64.tar.gz"
              sha256 "${SHA256_LINUX}"
            end

            def install
              bin.install "iconwolf"
            end

            def caveats
              <<~EOS
                iconwolf generates icon files into a directory you specify (default: ./assets/images/).
                Those output files are your project assets and are NOT managed by Homebrew.

                To fully remove iconwolf:
                  brew uninstall iconwolf

                This removes the CLI binary. No other cleanup needed.
              EOS
            end

            test do
              assert_match "${VERSION}", shell_output("#{bin}/iconwolf --version")
            end
          end
          RUBY

      - name: Commit and push
        run: |
          cd homebrew-den
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/iconwolf.rb
          git commit -m "Update iconwolf to ${{ steps.release.outputs.tag }}"
          git push
